In the uniform distribution case, one can precisely estimate the threshold $n^*$ that determines whether one should use the truncation or the expansion algorithm. However, when the source and target distributions are highly nonuniform, as is the case in most practical applications, it is not straightforward. For example, when we superimpose a regular grid structure of FGT on a nonuniform distribution, some boxes will have lot of points while some are almost empty. 

In this section, we present a scalable algorithm for nonuniform distributions based on the ideas introduced in \cite{veerapaneni08}. A main ingredient of our alogirithm is building an \emph{octree} from the given set of points% 
%
\footnote{The original FGT \cite{fgt} handles nonuniform distributions without using any sort of hierarchical data-structures. In principle, one can extend these ideas to the present context. However there are certain advantages of using octrees both at the implementational and algorithmic levels. [NEED TO EXPAND]}. 
%
We discuss this next.
%
\subsection{Parallel octrees}
We assume sources and targets are the same for simplicity. We also assume that the octree is constructed so that there are no more than a fixed number of points in each leaf node. 

\subsection{FGT on octrees}

\begin{algorithm}[!h]
\caption{{\em Tree Splitting}}
{\tt
\begin{algorithmic}
\STATE
  \FOR {each leaf node $\ell$}
      \IF {$|\ell| > \sqrt{\delta}$}
          \STATE assign $\ell$ to $T_d$ (direct or truncation based)
      \ELSE
          \STATE assign $\ell$ to $T_e$ (expansion based)
      \ENDIF
  \ENDFOR
\STATE
\end{algorithmic}
}
\end{algorithm}


\begin{algorithm}[!h]
\caption{\em FGT on a split tree}
%\label{a:ofgt}
{\tt
\begin{algorithmic}
\STATE
%\STATE {\sc FGT on a split Octree}
  \FOR {each $\ell \in T_e$}
      \STATE (S2W) Add contribution of point in $\ell$ to the FGT box it belongs
  \ENDFOR
  \STATE
  \STATE (W2L) Form local expansions using sweeping
  \STATE 

  \STATE {\sc Evaluate the effect of all sources in $T_d$}
  \FOR {each $\ell \in T_d$}
       \FOR {$x \in \ell$}
          \STATE Add contribution of $x$ to all the target boxes (in $T_e$) and target points (in $T_d$)     
       \ENDFOR  
  \ENDFOR
  
  \STATE 
  \STATE {\sc Evaluate the effect of all sources in $T_e$}
     \FOR {each FGT box $B \in T_e$}
        \STATE Use local expansion for target points within $B$ 
        \STATE
        \STATE Use wave expansion for target points in $T_e$ that are within its interaction list
     \ENDFOR  
\STATE
\end{algorithmic}
}
\end{algorithm}

\subsection{Overlapping communication with computation} 

{\em [In the parallel case, the interaction between $T_d$ and $T_e$ can be done while processors are communicating other info.] }

