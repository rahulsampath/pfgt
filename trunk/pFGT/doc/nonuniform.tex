In the uniform distribution case, one can precisely estimate the threshold $n^*$ that determines whether one should use the truncation or the expansion algorithm. However, when the source and target distributions are highly nonuniform, as is the case in most practical applications, it is not straightforward. For example, when we superimpose a regular grid structure of FGT on a nonuniform distribution, some boxes will have lot of points while some are almost empty. 

In this section, we present a scalable algorithm for nonuniform distributions based on the ideas introduced in \cite{veerapaneni08}. A main ingredient of our alogirithm is building an \emph{octree} from the given set of points% 
%
\footnote{The original FGT \cite{fgt} handles nonuniform distributions without using any sort of hierarchical data-structures. In principle, one can extend these ideas to the present context. However there are certain advantages of using octrees both at the implementational and algorithmic levels. [NEED TO EXPAND]}. 
%
We discuss this next.
%
\subsection{Parallel octrees}
We assume sources and targets are the same for simplicity. We also assume that the octree is constructed so that there are no more than a fixed number of points in each leaf node. 

\subsection{FGT on octrees}


\begin{algorithm}[!h]
\caption{{\em Tree Splitting}}
{\tt
\begin{algorithmic}
\STATE
  \FOR {each leaf node $\ell$}
      \IF {$|\ell| > \sqrt{\delta}$}
          \STATE assign $\ell$ to $T_d$ (direct or truncation based)
      \ELSE
          \STATE assign $\ell$ to $T_e$ (expansion based)
      \ENDIF
  \ENDFOR
\STATE
\end{algorithmic}
}
\end{algorithm}


Then the following are the different stages of the parallel algorithm;

{\em (i) S2W}. In this step, we form the plane-wave expansions at the set of boxes that cover $T_e$. 
We visit each leaf, and add its contribution to the box it is contained in or to all the boxes it contains. \hfill $\bigO(N p^3/n_p)$

{\em (ii) S2W-Comm.} Because the boxes are partitioned by [RAHUL] and the octree is partitioned by Morton ordering, the  
In each processor, we visit every box it owns and gather all the plane-wave expansions formed at the center of this box across processors. 
\hfill $\bigO(K^3 n_p)$

{\em (iii) W2D.} Each box $B \in T_e$ will visit every target point $x \in T_d$ in its interaction list and evaluates the Gauss transform at $x$ using:
%
\beq G[f](x) = \sum_{|k| \leq p} e^{-\frac{\norm{z_k}^2}{4}} e^{i z_k \cdot (x - c^B)/\sqrt{\delta}} w_k \eeq
%
1. For each point within each leaf marked as Direct, figure out the set of
FGT boxes whose interaction list contains this point.
2. For each FGT box computed above, figure out the processor that owns
it.
3. Send these FGT boxes to their respective owners.
4. The owner of an FGT box will return the source expansion for that box
to the processors that requested them in step 3. This communication is
like the reverse of the communication in step 3. Note, if an FGT box is
within a Direct octant then its source expansion can simply be set to
zero for this step. If we want to avoid communicating zero source 
expansions for FGT boxes within a Direct octant, then we require an extra 
communication for communicating which of the requested FGT boxes are empty and which are
not.  
5. For each point within each leaf marked as Direct, figure out the set
of FGT boxes whose interaction list contains this point and use the
corresponding values received in step 4 and compute the Gauss transform for this
point.
\hfill $\bigO(p^3 N / n_p)$
% assuming O(N) points in the direct tree

{\em (iv) D2D.}
1. For each point (p) within each octant marked as Direct, compute the
point (A) in the -ve corner and the point (B) in the +ve corner of p's
interaction list. Note, the Morton ids of all points in the interaction
list of point p will be >= that of point A and <= that of point B.
2. Gather the Morton id of the first (in the Morton sorted list) direct
octant on each processor. This will give the smallest Morton id of
direct octants on each processor. Handle the case where some processors
do not contain any direct octants.
3. Figure out the processor with the greatest value <= A in the list
computed in step 2.
4. Figure out the processor with the greatest value <= B in the list
computed in step 2.
5. Send point p and the corresponding source f to all processors that
lie between the processors computed in step 3 and step 4. Note, we are 
using the property that if the Morton id of Octant C < Morton id of 
Octant D then the Morton id of any point within Octant C is >  Morton
id of Octant C and is < Morton id of Octant D.
6. For each point p recieved in step 5, compute the
point (A) in the -ve corner and the point (B) in the +ve corner of p's
interaction list. Find the direct octant O1 with the maximum Morton id that
is <= A and the direct octant O2 with the maximum Morton id that is <=
B. Loop over the set of Direct octants O with Morton ids >= that of O1
and <= that of O2. Loop over the set of points within O that lie in the
interaction list of p. For each of these points, add the contribution to
the Gauss transform from p.
\hfill $\bigO(p^3 N/n_p)$

{\em (v) W2L.} To allow execution of the sweeping algorithm independently on each processor, we exchange the plane-wave expansions of $\lfloor K/2 \rfloor ^3$ boundary boxes across adjacent processors. 
\hfill $\bigO(15 p^3 |B|/n_p + K^3 p^3 n_p)$
% doin the sweep + communicating ghost values

{\em (vi) D2L.} This step is a dual of the $W2D$ step. 

\beq v_k += \, f(y) e^{i z_k \cdot (c^D - y)/\sqrt{\delta}} \eeq

1. For each point within each octant marked as Direct, loop over the set 
of FGT boxes that lie within this point's interaction list. For each of
these FGT boxes, add the contribution from this point.
2. Figure out the processors that own the FGT boxes computed in step 1.
3. Send the values computed in step 1 to the owner of the respective FGT
boxes.
4. On the recieving end, add the incoming values to the target
expansions for the corresponding FGT boxes. 
\hfill $\bigO(p^3 N / n_p)$

{\em (vii) L2T-Comm.} 
1. Send the target expansions for each FGT box owned by this processor
to the processors that own octants that are contained within this FGT
box. This communication is like a reverse of the communication in
S2W-Comm.  
\hfill $\bigO(K^3 n_p)$

{\em (viii) L2T.} 
For each leaf that is marked as Expand do the following:
  1. Do the same computation as in the uniform case for
  all points within this octant using the target expansion for the
  FGT box that contains this octant. 
\hfill $\bigO(N p^3/n_p)$

\begin{algorithm}[!h]
\caption{\em FGT on a split tree}
%\label{a:ofgt}
{\tt
\begin{algorithmic}
\STATE
%\STATE {\sc FGT on a split Octree}
  \FOR {each $\ell \in T_e$}
      \STATE (S2W) Add contribution of point in $\ell$ to the FGT box it belongs
  \ENDFOR
  \STATE
  \STATE (W2L) Form local expansions using sweeping
  \STATE 

  \STATE {\sc Evaluate the effect of all sources in $T_d$}
  \FOR {each $\ell \in T_d$}
       \FOR {$x \in \ell$}
          \STATE Add contribution of $x$ to all the target boxes (in $T_e$) and target points (in $T_d$)     
       \ENDFOR  
  \ENDFOR
  
  \STATE 
  \STATE {\sc Evaluate the effect of all sources in $T_e$}
     \FOR {each FGT box $B \in T_e$}
        \STATE Use local expansion for target points within $B$ 
        \STATE
        \STATE Use wave expansion for target points in $T_e$ that are within its interaction list
     \ENDFOR  
\STATE
\end{algorithmic}
}
\end{algorithm}

\subsection{Overlapping communication with computation} 

{\em [In the parallel case, the interaction between $T_d$ and $T_e$ can be done while processors are communicating other info.] }

