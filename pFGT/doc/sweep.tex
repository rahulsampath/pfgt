Translation, as we have seen in Section \ref{sc:fgt}, forms the local expansion at a target box by combining the plane-wave expansions of $K^3$ nearest source boxes. In most practical applications, not all boxes in the unit cube will be possess 
 For example, heat potentials can be classified into two categories: (i) volume potentials, which require convolutions of the form () in the entire volume $[0, 1]^3$, (ii) layer potentials, in which the sources reside only on manifolds embedded in $[0, 1]^3$. The volume potentials can 
% 
\begin{prob}
{\em Given a regular grid of size $1/n_b$ in the unit cube with $|B|$ non-zero boxes in it, find the optimal traversal path so that the cost of translation is minimized.
}
\end{prob}
%
In the uniform distribution case, $|B| = n_b^3$ and the cost of the direct scheme (\ref{}) is $\bigO(K^3 p^3 |B|)$. The sweeping algorithm introduced in \cite{greengard98} and extended to multidimensions in \cite{fggt} brings down the complexity to $\bigO(3dp^d |B|)$ in $d$ dimensions. Infact, we believe the following to be true. 

\begin{conj}
{\em If $|B| = n_b^3$, then the optimal cost of translation is $\bigO(3 d p^d)$ and the sweeping algorithm of \cite{greengard98} achieves it.}
\end{conj}

There are two problems with the sweeping algorithm in the general case.  
First, a naive implementation of the sweeping algorithm stores data in all the $n_b^3$ boxes. This could be detrimental both for the adaptive volume and the surface potentials as $|B| << n_b^3$. Second, its performance is worse than the direct scheme in the surface potential case. This is because 


In this section, we propose two algorithms: one for eliminating the storage requirements in the volume case and achieving nearly optimal complexity and the other is an optimal algorithm for the surface potentials. We also present a decision making algorithm which picks the optimal of the two for any given distribution of nonzero boxes. 

%We propose a new algorithm for accelerating the plane-wave
%translations, which only needs $\mathcal{O}(|B|^\frac{d-1}{d})$ storage instead
%of $\mathcal{O}(|B|)$ storage as required by the sweeping algorithm from
%\cite{fggt}. For cases where direct computation is more efficient compared to the sweeping
%algorithm, for example when the sources are distributed on the surface of a sphere, we propose
%a new method to {\em a priori} estimate the best way to traverse space. We use the direct scheme if the estimated cost of the direct scheme is lower than that of the sweep. The method for estimating the cost of the most efficient direct scheme is described in Section \ref{sec:mst}.

% NOT CORRECT ...
% In addition, the algorithm is work optimal for distributions with \ul{distribution density} less than $60\%$ (for $d=3$).

\subsection{Modified sweeping algorithm for volume distributions} 
\label{sec:sweep}
Instead of sweeping along each dimension one-by-one as with the method proposed 
in \cite{fggt}, our algorithm visits each box only once and computes the full plane-wave
translation based on its neighbours which have already been visited. The
plane-wave expansions at a box $B_i$ can be represented as a combination of the
plane-wave expansions of its $2^{d} -1$ neighbours, along with corrections for
$2^d$ boxes. We start with direct computation of the outermost layer, and then propagate it inwards, layer by layer, as illustrated in Figure \ref{fig:sweep}. This results in an overall complexity of the sweep algorithm as $\mathcal{O}((2^{d+1} -1)p^d|B|)$. The constant in the
complexity for this step increases from $3d\rightarrow2^{d+1} - 1$, which is
from $6\rightarrow7$ for $d=2$ and from $9\rightarrow15$ for $d=3$. 

The algorithm is illustrated in Figure \ref{fig:w2l}. The steps involved in the
algorithm are as follows, 
\begin{enumerate}    
  \item First compute the local expansions at the outermost layer of the FGT
    boxes. Full computation ($K^dp^d$) is only required for the first box, as
    the local expansions for the other boxes can be computed by adding and
    subtracting layers from the expansions of the already computed boxes. 
  
  \item We propagate the local expansions from this initial layer to subsequent
    layers. Consider the case shown in Figure \ref{fig:w2l} where we need to
    compute the local expansion of the Green box ( $B(i+1,j+1)$), given the
    local expansions of the adjacent boxes (in Orange).  
  
  \item The local expansion $v_k^{B(i+1, j+1)}$ can be written in terms for the
    local expansions of the $2^d -1$ neighbours $B(i,j), B(i+1,j)$ and
    $B(i,j+1)$, along with corrections terms from the $2^d$ corners.
    These are marked in Figure \ref{fig:w2l} assuming $K=3, n=1$. 
    The local expansion can therefore be computed as,
    \begin{eqnarray*} 
    % v_k^{i+1,j+1} &=& \sum_{\eta_{i,j} = 0,1} (-1)^{1 + d + |\eta|_1} e^{i\lambda k\cdot\eta} v_k^{i+\eta_i, j+\eta_j} \\
    v_k^x &=& \sum_{\eta \in \mathcal{N}(x)} (-1)^{1 + d + |\eta|_1} e^{i\lambda k\cdot\eta} v_k^{x+\eta} \\
    % & +& \sum_{\eta_{i,j}= 0,1} (-1)^{1 + d + |\eta|_1} e^{iz_k\eta ns/\sqrt{\delta}} w_k^{i+\eta_i, j+\eta_j}.
    & +& \sum_{\chi \in \mathcal{C}(x)} (-1)^{1 + d + |\chi|_1} e^{i\lambda k\cdot\chi} w_k^{x+\chi}.
    \end{eqnarray*}
    where $\mathcal{C}(\cdot)$ assigns the sign to the contribution of the specific neighbour or corner. Specifically, it is 
    \[
      \mathcal{C}(x) = (-1)^{1+d+|x|_1}
    \]
    
 %   e^{iz_k s/\sqrt{\delta}} v_k^{i+1,j} + e^{iz_k s/\sqrt{\delta}} v_k^{i,j+1} - e^{iz_k s/\sqrt{\delta}} v_k^{i,j} - e^{iz_k ns/\sqrt{\delta}} w_k^{i+n+1,j+n+1} + e^{-iz_k ns/\sqrt{\delta}} w_k^{i-n,j-n}
  
  \item The propagation can then be used to propagate to the remaining boxes in
    the new propagation layer. At any given stage only the values of the
    propagation layer needs to be stored. The values at any box with zero
    coefficient can therefore be ignored and need not be stored.

\end{enumerate}


\begin{figure}
\centering
\begin{tikzpicture}[scale=0.5]
	
	\draw[fill=orange!30] (0,0) rectangle +(8,2);
	\draw[fill=orange!30] (0,2) rectangle +(2,6);

	\draw[fill=green!30!black!30] (2,2) rectangle +(6,2);
	\draw[fill=green!30!black!30] (2,4) rectangle +(2,4);
	
	\draw[fill=green!50!black!30] (4,4) rectangle +(4,2);
	\draw[fill=green!50!black!30] (4,6) rectangle +(2,2);
	
	\draw[fill=green!10] (6,6) rectangle +(2,2);
	
	% arrows ...
	\draw[green!50!black, thick, ->] (1,1) -- (7,7) node[above] {$r$}; 
												
	% the grid ...
	\draw[step=2cm] (0,0) grid (8,8);	
	
\end{tikzpicture}
\caption{\small The outermost layer is shown in orange, for which the local expansions are computed directly. The other layers (in green) are computed by propagation. The direction of propagation ($r$) is shown using the arrow and by the shade of the layers, lighter being later in time.
}
\label{fig:sweep}
\end{figure}

\begin{figure}
\centering
\begin{tikzpicture}[scale=0.5]
	
	\draw[fill=orange!30] (2,2) rectangle +(4,2);
	\draw[fill=orange!30] (2,2) rectangle +(2,4);
	
	\draw[fill=green!10] (4,4) rectangle +(2,2);		
	% the grid ...
	\draw[step=2cm] (0,0) grid (8,8);	
	
	\draw (3,3) node {$i, j$};
	\draw (5,3) node {$i+1, j$};
	\draw (3,5) node {$i, j+1$};
	\draw (5,5) node {$i+1, j+1$};
	
	\draw (1,1) node {$-$};
	\draw (7,7) node {$-$};
	\draw (1,7) node {$+$};
	\draw (7,1) node {$+$};
			
\end{tikzpicture}
\caption{\small The propagation of the local expansions using neighbors. 
}
\label{fig:w2l}
\end{figure}

\subsection{Modified sweeping algorithm for surface distributions} 
\label{sec:mst}
The cost of the first box for which we need to compute the plane-wave translations is $\mathcal{O}(n_bp^3)$, where $n_b$ are the number of non-zero boxes in the incidence list of the box. For subsequent boxes, we only need to consider the difference between the incidence list of the current box and that of boxes previously visited. The problem is therefore to determine the optimal traversal such the the overall cost is reduced. We pose the problem as one of finding the minimum spanning tree of a graph. The graph is made of all non-zero boxes as its vertices, along with one additional special vertex. This vertex is connected to all remaining vertices by edges whose weight is equal to the number of non-zero boxes in the incidence list of the target vertex. This encodes the cost of the direct computation for the target box, and is there to enable the start of the direct computation from any given box. Each of the remaining vertices (FGT boxes) are connected to a maximum of $26$ other vertices (corresponding to the immediate non-zero neighbors of the box). The weight of an edge between boxes $B_i$ and $B_j$ is equal to the number of boxes in $\mathcal{I}(B_i)\cup\mathcal{I}(B_j) - \mathcal{I}(B_i)\cap\mathcal{I}(B_j)$.    

We compute the minimum spanning tree of this graph using Kruskal's method \cite{kruskal56}. For most practical cases our graph is sparse ($E\le13V$). The complexity of computing the minimum spanning tree is $\mathcal{O}(E\log V)$, which in our case becomes $\mathcal{O}(n\log n)$, where $n$ is the number of non-zero boxes. The total cost of the tree is used to determine whether to use the direct approach or to use the sweeping or the propagation scheme described in Section \ref{sec:sweep}. The edges of the tree gives us the optimal traversal to compute the plane-wave translations. \ul{Need to add example traversal graph and cost estimate for the sphere traversal.}

\begin{table*}[bht]
\centering
\begin{tabular}{cccc}\hline
         $|B|$  &  direct & MST & ratio \\ \hline
         xxx & & &  \\  
        xxxx & & &  \\  
       xxxxx & & &  \\  
\hline
\end{tabular}
\caption{Number of boxes visited.\label{count}}
\end{table*}